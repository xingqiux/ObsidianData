## 1. Nacos注册中心
### 1.1 注册中心简介

注册中心是微服务架构中的核心组件，它可以实现服务提供方和服务消费方的解耦。

**工作流程**：
1. 服务提供方在启动时，向注册中心注册自己的服务详情（IP、端口号等）。注册中心维护一张服务清单，并通过心跳机制监测服务是否可用，剔除不可用的服务。
2. 服务消费方向注册中心查询服务，获取服务实例清单，然后按照指定的负载均衡算法选择一个服务实例进行访问。

---
### 1.2 Nacos简介

Nacos（**Na**ming and **Co**nfiguration **S**ervice）是阿里巴巴开源的一个更易于构建云原生应用的动态服务发现、配置管理和服务管理平台。

**Nacos的优点**：
1. **高可用性**：支持多节点部署，通过选举算法实现高可用和故障转移能力
2. **动态扩展性**：可根据实际需求进行快速扩展和缩容
3. **完备的功能支持**：支持服务注册与发现、配置管理、流量管理、DNS解析等
4. **易于集成**：提供多种语言和框架的集成方案，支持Spring Cloud等流行微服务框架

Nacos的核心价值在于解决微服务架构中的关键问题，这些问题在传统单体应用中并不明显：

### 1.2(续) 为什么需要Nacos？

**没有注册中心的痛点：**

- **硬编码服务地址**：服务A调用服务B需要写死IP和端口
- **扩容困难**：服务B增加实例后，服务A无法感知新实例
- **服务健康状态难以管理**：服务B的某个实例宕机，服务A仍可能向其发送请求
- **负载均衡实现复杂**：需要自己编写代码实现多实例间的负载均衡
 
**Nacos提供的核心功能：**

1. **服务注册与发现**：
    - 服务提供者自动注册到Nacos
    - 服务消费者通过服务名而非IP地址调用服务
    - 实例变化时自动感知，无需修改代码
2. **动态配置管理**：
    - 集中管理所有微服务的配置
    - 配置变更时自动推送，无需重启服务
    - 支持配置版本管理和回滚
3. **智能路由**：
    - 可基于权重的路由策略
    - 支持就近路由、同区域优先
4. **健康检查**：
    - 自动检测服务实例健康状态
    - 自动剔除不健康的服务实例 **实际例子**： 假设有一个电商系统，包含用户服务、订单服务、商品服务，每个服务部署多个实例。当用户服务需要调用订单服务时：

- **无注册中心**：必须写死订单服务的IP和端口，增加/减少实例需修改代码
- **有Nacos**：用户服务只需知道"订单服务"的名称，Nacos负责找到可用的订单服务实例，并支持负载均衡

---
### 1.3 Nacos安装
#### 1.3.1 使用Docker安装Nacos
```shell
# 拉取镜像
docker pull nacos/nacos-server:v2.2.2
# 创建容器
docker run --name nacos -e MODE=standalone -p 8848:8848 -p 9848:9848 -d nacos/nacos-server:v2.2.2
# 注意：nacos2.x版本新增了客户端与服务端的gRpc通讯端口9848
```

安装完成后，通过浏览器访问：`http://192.168.136.142:8848/nacos`（IP改为您的服务器IP）
登录用户名和密码均为：`nacos`
![Nacos控制台](image-20230503164647894.png)

#### 1.3.2 Windows环境安装Nacos

1. 下载Nacos安装文件
   ![Nacos下载](image-20230809095554425.png)
2. 解压到没有中文和空格的目录
3. 进入bin目录，使用cmd打开，通过命令启动Nacos服务：
   ```
   startup.cmd -m standalone
   ```
   ![Nacos启动](image-20230809095749386.png)
4. 浏览器访问：`http://localhost:8848/nacos`，账号密码同样是`nacos/nacos`

---
### 1.4 微服务集成Nacos

**需求**：将service-product微服务注册到Nacos中
**实现步骤**：
1. 引入依赖
   ```xml
   <!-- nacos作为注册中心的依赖 -->
   <dependency>
       <groupId>com.alibaba.cloud</groupId>
       <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
   </dependency>
   ```
2. 在`application.yml`文件中添加配置
   ```yaml
   spring:
     application:
       name: service-product
     cloud:
       nacos:
         discovery:
           server-addr: localhost:8848
   ```
3. 启动微服务后，可以在Nacos控制台看到注册信息：
   ![服务注册成功](image-20230911104850311.png)

