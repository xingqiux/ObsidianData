# JWT (JSON Web Token) 相关问题解答

## 1. JWT的基本组成部分是什么？各部分的作用是什么？

JWT由三部分组成，以点（.）分隔：
- **Header（头部）**：包含令牌类型（typ）和使用的签名算法（alg），如HMAC、SHA256或RSA。它是Base64Url编码的JSON。
- **Payload（负载）**：包含声明（claims），即实体（通常是用户）和其他数据的声明。有三种类型的声明：注册声明（如iss、exp、sub等）、公共声明和私有声明。同样是Base64Url编码的JSON。
- **Signature（签名）**：使用指定的算法对编码后的header、编码后的payload和密钥进行签名，用于验证消息在传输过程中没有被更改。

## 2. JWT相比传统session认证有什么优势和劣势？

**优势：**
- **无状态**：服务器不需要存储会话信息，减轻了服务器负担
- **可扩展性好**：便于分布式系统和微服务架构
- **跨域友好**：可以在不同域名下的API之间共享
- **减少数据库查询**：token中已包含用户信息，减少了查询数据库的需求
- **移动端应用友好**：适用于原生移动应用

**劣势：**
- **安全存储问题**：客户端存储令牌存在安全风险
- **令牌大小**：JWT包含更多信息，比简单的session ID更大
- **无法立即撤销**：除非使用黑名单，否则在有效期内无法撤销已签发的令牌
- **密钥管理**：需要妥善保管签名密钥
- **增加前端复杂性**：需要前端处理令牌存储和刷新


## 4. JWT令牌过期后，如何优雅地处理刷新令牌机制？

**刷新令牌机制实现：**
1. **签发两种令牌**：
   - 短期访问令牌（access token）用于API访问
   - 长期刷新令牌（refresh token）用于获取新的访问令牌

2. **过期处理流程**：
   - 前端检测到401响应（令牌过期）
   - 使用刷新令牌调用刷新API
   - 获取新的访问令牌并重试原请求
   - 如果刷新令牌也过期，则重定向到登录页面

3. **优化方案**：
   - 实现请求拦截器自动处理刷新流程
   - 使用请求队列处理令牌刷新期间的并发请求
   - 实现滑动过期窗口延长刷新令牌生命周期

## 5. 如何防范JWT相关的常见安全问题？

**常见安全措施：**
- **设置合理的过期时间**：短期访问令牌（如15分钟到2小时）减少被盗用的风险
- **使用强密钥**：签名密钥应该足够复杂且定期轮换
- **验证签名**：始终验证JWT签名确保其未被篡改
- **实现令牌撤销机制**：关键场景下使用黑名单或令牌版本控制
- **使用HTTPS**：确保令牌传输加密
- **避免在payload中存储敏感信息**：JWT payload可以被解码查看
- **增加指纹信息**：在令牌中加入设备标识或IP信息增加安全性
- **实现CSRF防护**：即使使用JWT也需要防范CSRF攻击
- **使用`nbf`（Not Before）声明**：防止令牌提前使用
- **注意算法选择**：避免使用有已知漏洞的算法（如none算法）

通过综合应用这些安全实践，可以最大限度地保护基于JWT的认证系统。